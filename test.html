<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月相盈虧模擬 (疊圖與覆蓋方式 - 全圖傾斜)</title>
    <style>
        body {
            margin: 0;
            overflow-x: hidden; /* 允許垂直滾動，水平隱藏 */
            display: flex;
            flex-direction: column; /* 垂直排列圖形 */
            align-items: center;
            min-height: 100vh;
            background-color: #000; /* 純黑色背景 */
            color: #eee;
            font-family: sans-serif;
            font-size: 14px;
            padding: 20px 0; /* 上下留白 */
        }
        .figure-wrapper {
            margin-bottom: 40px; /* 每個圖形之間間距 */
            background-color: #1a1a1a; /* 每個圖形區塊的背景色 */
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        h3 {
            color: #fff;
            margin-top: 0;
            margin-bottom: 15px;
        }
        canvas {
            background-color: #222; /* Canvas 背景色，在圖片載入失敗時可見 */
            border: 2px solid #555;
            display: block;
            margin: 0 auto; /* 讓 canvas 在其容器中居中 */
        }
        #version-info {
            position: fixed; /* 固定在視窗左上角 */
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="version-info">版本: v2025.07.05.14</div>

    <div class="figures-container">
        </div>

    <script>
        // --- 設定版本號 ---
        const VERSION = 'v2025.07.05.14';
        document.getElementById('version-info').innerText = `版本: ${VERSION}`;

        const commonCanvasWidth = 400;
        const commonCanvasHeight = 400;
        const centerX = commonCanvasWidth / 2;
        const centerY = commonCanvasHeight / 2;
        const radius = 150; // 圓的半徑
        const dotSize = 2; // 每個點的大小 (像素)
        const numDots = 180; // 繪製點的數量 (從 90 到 270 度，每度一個點)
        const tiltAngleDegrees = 23.4; // 月亮的傾斜角度
        const tiltAngleRadians = tiltAngleDegrees * Math.PI / 180; // 轉換為弧度

        // 加載月亮底圖
        const moonImage = new Image();
        moonImage.src = 'https://raeltw.github.io/wea.tw/moon/moon256.png'; // 你提供的底圖網址

        // 輔助函數：旋轉點
        function rotatePoint(px, py, cx, cy, angle) {
            const tempX = px - cx;
            const tempY = py - cy;

            const rotatedX = tempX * Math.cos(angle) - tempY * Math.sin(angle);
            const rotatedY = tempX * Math.sin(angle) + tempY * Math.cos(angle);

            return {
                x: rotatedX + cx,
                y: rotatedY + cy
            };
        }

        // 繪製單一 Canvas 圖形的函數
        function drawFigure(canvas, illuminatedPercentage, backgroundImage) {
            const ctx = canvas.getContext('2d');

            // 1. 清空 Canvas
            ctx.clearRect(0, 0, commonCanvasWidth, commonCanvasHeight);
            
            // 2. 繪製背景圖片 (現在會跟著傾斜)
            if (backgroundImage) {
                ctx.save(); // 保存當前 Canvas 狀態

                // 將原點移動到 Canvas 中心，以便繞中心旋轉
                ctx.translate(centerX, centerY);
                // 旋轉 Canvas
                ctx.rotate(tiltAngleRadians);
                // 繪製圖片，現在圖片的中心點位於新的原點 (0,0)
                ctx.drawImage(backgroundImage, -commonCanvasWidth / 2, -commonCanvasHeight / 2, commonCanvasWidth, commonCanvasHeight);
                
                ctx.restore(); // 恢復之前保存的 Canvas 狀態，這樣接下來的繪圖就不會再傾斜了
            } else {
                // 如果圖片載入失敗，則使用預設的 Canvas 背景色
                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, commonCanvasWidth, commonCanvasHeight);
            }


            // 3. 繪製圓心 (白色，作為旋轉的原點，因此不會移動)
            // 圓心點會繪製在未傾斜的座標系中，所以它的位置不變
            ctx.beginPath();
            ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();

            // 4. 繪製原始的藍色左半圓周上的點 (基礎點，現在整體會被傾斜的背景和點覆蓋)
            // 由於整個畫布已經傾斜，點的座標計算仍然在原來的座標系中，但繪製時會自動傾斜
            for (let i = 0; i <= numDots; i++) {
                const angleDegrees = 90 + i;
                const angleRadians = angleDegrees * Math.PI / 180;

                const x = centerX + radius * Math.cos(angleRadians);
                const y = centerY + radius * Math.sin(angleRadians);

                // 應用傾斜旋轉 - 這裡的旋轉是為了讓點的邏輯位置和旋轉後的底圖匹配
                const rotatedBluePoint = rotatePoint(x, y, centerX, centerY, tiltAngleRadians);

                ctx.fillStyle = '#00aaff'; // 藍色
                ctx.fillRect(rotatedBluePoint.x - dotSize / 2, rotatedBluePoint.y - dotSize / 2, dotSize, dotSize);
            }

            // 5. 繪製變換後的紅色點 (代表亮暗分界線，整體也會傾斜)
            const currentWalkPercentage = illuminatedPercentage; // 亮度百分比直接映射到點的水平位移

            for (let i = 0; i <= numDots; i++) {
                const angleDegrees = 90 + i;
                const angleRadians = angleDegrees * Math.PI / 180;

                const originalX = centerX + radius * Math.cos(angleRadians);
                const originalY = centerY + radius * Math.sin(angleRadians);

                const D0 = centerX - originalX;

                const moveDistance = (currentWalkPercentage / 100) * (2 * D0);

                const newXBeforeTilt = originalX + moveDistance;
                const newYBeforeTilt = originalY;

                // 應用傾斜旋轉 - 讓紅點跟藍點和背景圖一起傾斜
                const rotatedRedPoint = rotatePoint(newXBeforeTilt, newYBeforeTilt, centerX, centerY, tiltAngleRadians);

                ctx.fillStyle = '#ff0000'; // 紅色
                ctx.fillRect(rotatedRedPoint.x - dotSize / 2, rotatedRedPoint.y - dotSize / 2, dotSize, dotSize);
            }
        }

        // 當圖片載入完成後，才開始動態生成並繪製所有 Canvas
        moonImage.onload = () => {
            const figuresContainer = document.querySelector('.figures-container');
            // 從 100% 亮度開始，每 5% 遞減，直到 0%
            for (let p = 100; p >= 0; p -= 5) {
                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';

                const title = document.createElement('h3');
                title.textContent = `月相模擬：亮度 ${p}%`;
                wrapper.appendChild(title);

                const canvas = document.createElement('canvas');
                canvas.id = `canvas${p}`;
                canvas.width = commonCanvasWidth;
                canvas.height = commonCanvasHeight;
                wrapper.appendChild(canvas);

                figuresContainer.appendChild(wrapper);

                // 繪製內容，傳入加載好的圖片
                drawFigure(canvas, p, moonImage);
            }
        };

        // 處理圖片載入失敗的情況
        moonImage.onerror = () => {
            alert('無法載入月亮底圖，請檢查圖片網址或網路連線。將顯示無底圖版本。');
            const figuresContainer = document.querySelector('.figures-container');
            for (let p = 100; p >= 0; p -= 5) {
                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                const title = document.createElement('h3');
                title.textContent = `月相模擬：亮度 ${p}% (無底圖)`;
                wrapper.appendChild(title);
                const canvas = document.createElement('canvas');
                canvas.id = `canvas${p}`;
                canvas.width = commonCanvasWidth;
                canvas.height = commonCanvasHeight;
                wrapper.appendChild(canvas);
                figuresContainer.appendChild(wrapper);
                drawFigure(canvas, p, null); // 傳入 null 表示沒有背景圖片
            }
        };
    </script>
</body>
</html>