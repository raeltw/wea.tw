<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月相盈虧模擬 (完整週期)</title>
    <style>
        body {
            margin: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #000;
            color: #eee;
            font-family: sans-serif;
            font-size: 14px;
            padding: 20px 0;
        }
        h2 {
            color: #fff;
            margin-top: 30px;
            margin-bottom: 20px;
            width: 100%;
            text-align: center;
        }
        .figures-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            margin-bottom: 40px; /* 增加容器底部間距 */
        }
        .figure-wrapper {
            background-color: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            
            width: 320px; 
            height: 320px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        h3 {
            color: #fff;
            margin-top: 0;
            margin-bottom: 15px;
        }
        canvas {
            background-color: #222;
            border: 2px solid #555;
            display: block;
            margin: 0 auto;
        }
        #version-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="version-info">版本: v2025.07.05.19</div>

    <h2>月相盈虧模擬 - 正在變亮 (Waxing)</h2>
    <div id="waxing-container" class="figures-container">
        </div>

    <h2>月相盈虧模擬 - 正在變暗 (Waning)</h2>
    <div id="waning-container" class="figures-container">
        </div>

    <script>
        const VERSION = 'v2025.07.05.19';
        document.getElementById('version-info').innerText = `版本: ${VERSION}`;

        const moonImage = new Image();
        moonImage.src = 'https://raeltw.github.io/wea.tw/moon/moon256.png';

        // 輔助函式：旋轉點 (保持不變)
        function rotatePoint(px, py, cx, cy, angle) {
            const tempX = px - cx;
            const tempY = py - cy;
            const rotatedX = tempX * Math.cos(angle) - tempY * Math.sin(angle);
            const rotatedY = tempX * Math.sin(angle) + tempY * Math.cos(angle);
            return { x: rotatedX + cx, y: rotatedY + cy };
        }

        /**
         * 繪製月相圖的函式。
         * 這個函式會動態創建一個 Canvas 並放入指定的 div 中，然後繪製月相。
         *
         * @param {string} targetDivId 目標 div 的 ID，Canvas 將會被創建並放入此 div 中。
         * @param {number} radius 月亮圓形（藍點/紅點構成的圓形）的半徑。
         * @param {number} illuminatedPercentage 月亮的亮度百分比 (0-100)。
         * @param {boolean} isWaning 如果為 true，表示月亮正在變暗 (滿月到新月)；如果為 false，表示月亮正在變亮 (新月到滿月)。
         */
        function maskmoon(targetDivId, radius, illuminatedPercentage, isWaning) {
            const targetDiv = document.getElementById(targetDivId);
            if (!targetDiv) {
                console.error(`找不到 ID 為 ${targetDivId} 的 div 元素。請確認 HTML 中存在該 ID。`);
                return;
            }

            const canvasWidth = targetDiv.clientWidth;
            const canvasHeight = targetDiv.clientHeight;

            if (canvasWidth === 0 || canvasHeight === 0) {
                 console.warn(`警告：目標 div (${targetDivId}) 的寬度或高度為 0。Canvas 將無法繪製。請確保該 div 在 CSS 中有明確的尺寸 (例如：width: 320px; height: 320px;)。`);
                 return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            targetDiv.innerHTML = ''; 
            targetDiv.appendChild(canvas);

            const ctx = canvas.getContext('2d');

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const dotSize = 2; // 點的大小 (像素)
            const tiltAngleDegrees = 23.4; // 月亮的傾斜角度
            const tiltAngleRadians = tiltAngleDegrees * Math.PI / 180; // 轉換為弧度

            // 1. 繪製背景圖片 (傾斜)
            if (moonImage.complete && moonImage.naturalWidth > 0) {
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(tiltAngleRadians);
                ctx.drawImage(moonImage, -canvasWidth / 2, -canvasHeight / 2, canvasWidth, canvasHeight);
                ctx.restore();
            } else {
                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                console.warn('月亮底圖尚未載入或載入失敗，顯示預設背景。');
            }

            // 將亮度百分比轉換為 0 到 1 的正規化值
            const p_norm = illuminatedPercentage / 100;

            // 2. 繪製月相遮罩 (黑色陰影)
            ctx.fillStyle = '#000'; // 陰影顏色

            if (p_norm <= 0) { // 新月 (完全變暗)
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2); // 繪製一個完整的黑色圓形
                ctx.fill();
            } else if (p_norm >= 1) { // 滿月 (完全變亮)
                // 不需要繪製陰影，背景圖片就是滿月
            } else {
                ctx.beginPath();

                // 根據盈虧階段繪製靜態半邊陰影 (滿月到半月之間，一半是固定陰影)
                if (isWaning) { // 正在變暗 (Waning: 滿月到新月)，陰影從右側增長，亮部在左側
                    // 繪製右半邊的固定陰影
                    ctx.arc(centerX, centerY, radius, -Math.PI / 2, Math.PI / 2, false); // 右半圓 (從上方 -90 度到下方 90 度，順時針)
                } else { // 正在變亮 (Waxing: 新月到滿月)，陰影從左側減少，亮部在右側
                    // 繪製左半邊的固定陰影
                    ctx.arc(centerX, centerY, radius, Math.PI / 2, Math.PI * 3 / 2, false); // 左半圓 (從下方 90 度到上方 270 度，順時針)
                }

                // 繪製動態的彎曲終結線 (terminator)
                // 終結線弧形的中心點 X 座標計算
                // 這個值控制了弧形的彎曲程度，模擬月相變化
                let terminatorArcCenterX;
                if (isWaning) { // 正在變暗：亮部在左側，陰影從右側向左側推進
                    // 終結線弧形中心從右側 (p_norm=0) 移向左側 (p_norm=1)
                    // 當 p_norm=1 (滿月)，terminatorArcCenterX = centerX - radius
                    // 當 p_norm=0.5 (下弦月)，terminatorArcCenterX = centerX
                    // 當 p_norm=0 (新月)，terminatorArcCenterX = centerX + radius
                    terminatorArcCenterX = centerX - radius * (2 * p_norm - 1);
                    ctx.arc(terminatorArcCenterX, centerY, radius, Math.PI / 2, Math.PI * 3 / 2, true); // 弧線從下方到上方 (逆時針)
                } else { // 正在變亮：亮部在右側，陰影從左側向右側推進
                    // 終結線弧形中心從左側 (p_norm=0) 移向右側 (p_norm=1)
                    // 當 p_norm=0 (新月)，terminatorArcCenterX = centerX + radius
                    // 當 p_norm=0.5 (上弦月)，terminatorArcCenterX = centerX
                    // 當 p_norm=1 (滿月)，terminatorArcCenterX = centerX - radius
                    terminatorArcCenterX = centerX + radius * (2 * p_norm - 1);
                    ctx.arc(terminatorArcCenterX, centerY, radius, Math.PI * 3 / 2, Math.PI / 2, true); // 弧線從上方到下方 (逆時針)
                }
                ctx.closePath(); // 閉合路徑
                ctx.fill(); // 填充陰影
            }

            // --- 紅點、藍點、中心白點的程式碼標註開始 ---

            // 3. 繪製藍點 (你可以將這段註解或刪除來隱藏藍點)
            // ctx.fillStyle = '#00aaff'; // 藍色
            // for (let i = 0; i <= 180; i++) { // 這裡需要重新計算 bluePoints，或者直接繪製圓弧
            //     const angleDegrees = 90 + i;
            //     const angleRadians = angleDegrees * Math.PI / 180;
            //     const originalX = centerX + radius * Math.cos(angleRadians);
            //     const originalY = centerY + radius * Math.sin(angleRadians);
            //     const rotatedPoint = rotatePoint(originalX, originalY, centerX, centerY, tiltAngleRadians);
            //     ctx.fillRect(rotatedPoint.x - dotSize / 2, rotatedPoint.y - dotSize / 2, dotSize, dotSize);
            // }

            // 4. 繪製紅點 (你可以將這段註解或刪除來隱藏紅點)
            // 由於陰影繪製邏輯已改變，紅點的生成方式需要重新思考其意義，
            // 或與新的月相繪製方式同步。目前保持註解。
            // ctx.fillStyle = '#ff0000'; // 紅色
            // const numDots = 180;
            // for (let i = 0; i <= numDots; i++) {
            //     const angleDegrees = 90 + i;
            //     const angleRadians = angleDegrees * Math.PI / 180;
            //     const originalX = centerX + radius * Math.cos(angleRadians);
            //     const originalY = centerY + radius * Math.sin(angleRadians);
            //     const D0 = centerX - originalX;
            //     const newXBeforeTilt = originalX + (illuminatedPercentage / 100) * (2 * D0);
            //     const rotatedRedPoint = rotatePoint(newXBeforeTilt, originalY, centerX, centerY, tiltAngleRadians);
            //     ctx.fillRect(rotatedRedPoint.x - dotSize / 2, rotatedRedPoint.y - dotSize / 2, dotSize, dotSize);
            // }
            
            // --- 紅點和藍點的程式碼標註結束 ---


            // --- 中心白點的程式碼標註開始 ---

            // 5. 繪製圓心 (白色) (你可以將這段註解或刪除來隱藏中心白點)
            ctx.beginPath();
            ctx.arc(centerX, centerY, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#fff';
            ctx.fill();

            // --- 中心白點的程式碼標註結束 ---
        }

        // 當月亮底圖圖片載入完成後，執行範例繪圖迴圈
        moonImage.onload = () => {
            const waxingContainer = document.getElementById('waxing-container');
            const waningContainer = document.getElementById('waning-container');
            const defaultRadiusForExample = 160; // 配合 320x320 畫布可完全覆蓋

            // 繪製「正在變亮 (Waxing)」階段的月相 (新月到滿月)
            for (let p = 0; p <= 100; p += 5) {
                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                const uniqueDivId = `waxingPhaseWrapper_${p}`;
                wrapper.id = uniqueDivId;

                const title = document.createElement('h3');
                title.textContent = `亮度 ${p}%`;
                wrapper.appendChild(title);

                waxingContainer.appendChild(wrapper);
                maskmoon(uniqueDivId, defaultRadiusForExample, p, false); // isWaning = false
            }

            // 繪製「正在變暗 (Waning)」階段的月相 (滿月到新月)
            // 從 100% 亮度開始，遞減到 0%
            for (let p = 100; p >= 0; p -= 5) {
                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                const uniqueDivId = `waningPhaseWrapper_${p}`;
                wrapper.id = uniqueDivId;

                const title = document.createElement('h3');
                title.textContent = `亮度 ${p}%`;
                wrapper.appendChild(title);

                waningContainer.appendChild(wrapper);
                maskmoon(uniqueDivId, defaultRadiusForExample, p, true); // isWaning = true
            }
        };

        // 處理月亮底圖圖片載入失敗的情況
        moonImage.onerror = () => {
            alert('無法載入月亮底圖，請檢查圖片網址或網路連線。所有月相圖將顯示為預設背景。');
            const waxingContainer = document.getElementById('waxing-container');
            const waningContainer = document.getElementById('waning-container');
            const defaultRadiusForExample = 160;

            for (let p = 0; p <= 100; p += 5) {
                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                const uniqueDivId = `waxingPhaseWrapper_${p}`;
                wrapper.id = uniqueDivId;
                const title = document.createElement('h3');
                title.textContent = `亮度 ${p}% (無底圖)`;
                wrapper.appendChild(title);
                waxingContainer.appendChild(wrapper);
                maskmoon(uniqueDivId, defaultRadiusForExample, p, false);
            }

            for (let p = 100; p >= 0; p -= 5) {
                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                const uniqueDivId = `waningPhaseWrapper_${p}`;
                wrapper.id = uniqueDivId;
                const title = document.createElement('h3');
                title.textContent = `亮度 ${p}% (無底圖)`;
                wrapper.appendChild(title);
                waningContainer.appendChild(wrapper);
                maskmoon(uniqueDivId, defaultRadiusForExample, p, true);
            }
        };

    </script>
</body>
</html>