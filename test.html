<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月相盈虧模擬 (最終版 - 間距與傾斜修正)</title>
    <style>
        body {
            margin: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #000;
            color: #eee;
            font-family: sans-serif;
            font-size: 14px;
            padding: 20px 0;
        }
        h2 {
            color: #fff;
            margin-top: 30px;
            margin-bottom: 20px;
            width: 100%;
            text-align: center;
        }
        .figures-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            margin-bottom: 40px;
        }
        .moon-unit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        .percentage-label {
            color: #eee;
            font-size: 14px; 
            margin-bottom: 5px;
            text-align: center;
        }
        .figure-wrapper {
            background-color: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        canvas {
            background-color: #222;
            border: 2px solid #555;
            display: block;
            margin: 0 auto;
        }
        #version-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="version-info">版本: v2025.07.05.58 (比例 1:1)</div>

    <h2>左側為起點往右邊走 (盈月：新月到滿月)</h2>
    <div id="left-container" class="figures-container"></div>

    <h2>右側為起點往左邊走 (虧月：滿月到新月)</h2>
    <div id="right-container" class="figures-container"></div>

    <script>
        const VERSION = 'v2025.07.05.58'; 
        document.getElementById('version-info').innerText = `版本: ${VERSION} (比例 1:1)`;

        const moonImg = new Image();
        moonImg.src = 'https://raeltw.github.io/wea.tw/moon/moon256.png';

        const scaleFactor = 1; // 縮放比例，目前為 1:1
        const targetMoonDiameterDisplay = 320; // 希望月亮主體（未傾斜時）在畫布上顯示的直徑
        const overallMarginRatio = 0.05; // 月亮傾斜後的包圍盒與 canvas 邊緣的間距比例 (例如 0.05 = 5% 邊距)

        const dotPixelSize = 3;       // 點陣的像素大小
        const maskLineThickness = 4;  // 遮罩線的像素粗細

        function rotatePoint(px, py, cx, cy, angle) {
            const tempX = px - cx;
            const tempY = py - cy;
            const rotatedX = tempX * Math.cos(angle) - tempY * Math.sin(angle);
            const rotatedY = tempX * Math.sin(angle) + tempY * Math.cos(angle);
            return { x: rotatedX + cx, y: rotatedY + cy };
        }

        // drawMoon 函數
        function drawMoon(divId, currScale, maskP, isRightToLeft = false, targetMoonDiam, marginRatio, dotSize, maskThickness) {
            const targetDiv = document.getElementById(divId);
            if (!targetDiv) return;

            const cWidth = targetDiv.clientWidth; 
            const cHeight = targetDiv.clientHeight;

            if (cWidth === 0 || cHeight === 0) return;

            const canvas = document.createElement('canvas');
            canvas.width = cWidth; 
            canvas.height = cHeight;
            targetDiv.innerHTML = ''; 
            targetDiv.appendChild(canvas);

            const ctx = canvas.getContext('2d');

            const cX = canvas.width / 2; 
            const cY = canvas.height / 2; 
            
            const tiltDeg = 23.4;
            const tiltRad = tiltDeg * Math.PI / 180;
            
            // 計算繪製月亮圖案和點陣的實際直徑 (已包含縮放因子)
            const moonDrawDiameter = targetMoonDiam * currScale;
            const radiusForDots = moonDrawDiameter / 2;

            const dots = 180; // 圓周上的點數

            if (moonImg.complete && moonImg.naturalWidth > 0) {
                ctx.save();
                ctx.translate(cX, cY); 
                ctx.rotate(tiltRad);
                ctx.drawImage(moonImg, -moonDrawDiameter / 2, -moonDrawDiameter / 2, moonDrawDiameter, moonDrawDiameter);
                ctx.restore();
            } else {
                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            const bluePts = [];
            const redPts = [];
            
            for (let i = 0; i <= dots; i++) {
                const angleDeg = isRightToLeft ? (-90 + i) : (90 + i);
                const angleRad = angleDeg * Math.PI / 180;

                // 藍點的原始位置 (相對於畫布中心和月亮直徑)
                const origX = cX + radiusForDots * Math.cos(angleRad);
                const origY = cY + radiusForDots * Math.sin(angleRad);

                // 旋轉藍點，旋轉中心為畫布中心
                const rBp = rotatePoint(origX, origY, cX, cY, tiltRad);
                bluePts.push(rBp);

                // 紅點的原始位置 (計算遮罩位移)
                const dist = cX - origX; 
                const newXB = origX + (maskP / 100) * (2 * dist);
                const newYB = origY;
                
                // 旋轉紅點，旋轉中心為畫布中心
                const rRp = rotatePoint(newXB, newYB, cX, cY, tiltRad);
                redPts.push(rRp);
            }

            ctx.strokeStyle = '#000';
            ctx.lineWidth = maskThickness; // 使用固定的遮罩線粗細
            ctx.lineCap = 'round';

            // 繪製黑線遮罩
            for (let i = 0; i < bluePts.length; i++) {
                ctx.beginPath();
                ctx.moveTo(bluePts[i].x, bluePts[i].y);
                ctx.lineTo(redPts[i].x, redPts[i].y);
                ctx.stroke();
            }

            // 繪製藍點 (在黑線之上)
            ctx.fillStyle = '#00aaff';
            for (const p of bluePts) {
                ctx.fillRect(p.x - dotSize / 2, p.y - dotSize / 2, dotSize, dotSize);
            }

            // 繪製紅點 (在黑線之上)
            ctx.fillStyle = '#ff0000';
            for (const p of redPts) {
                ctx.fillRect(p.x - dotSize / 2, p.y - dotSize / 2, dotSize, dotSize);
            }
            
            // 繪製中心白點 (在所有點之上)
            ctx.beginPath();
            ctx.arc(cX, cY, dotSize, 0, Math.PI * 2); // 中心點大小與其他點相同
            ctx.fillStyle = '#fff';
            ctx.fill();
        }

        moonImg.onload = () => {
            const leftContainer = document.getElementById('left-container');
            const rightContainer = document.getElementById('right-container');
            
            const tiltDeg = 23.4;
            const tiltRad = tiltDeg * Math.PI / 180;

            // 計算傾斜後的月亮 (targetMoonDiameterDisplay) 所需的最小包圍盒尺寸
            const moonBBoxNoMargin = targetMoonDiameterDisplay * (Math.abs(Math.cos(tiltRad)) + Math.abs(Math.sin(tiltRad)));
            
            // 計算最終 canvas 的基礎尺寸，包含邊距
            const canvasBaseSize = moonBBoxNoMargin / (1 - 2 * overallMarginRatio);
            const finalCanvasBaseSize = Math.ceil(canvasBaseSize); // 向上取整以確保足夠空間

            for (let p = 100; p >= 0; p -= 5) {
                const unitItem = document.createElement('div');
                unitItem.className = 'moon-unit-item';

                const label = document.createElement('div');
                label.className = 'percentage-label';
                const scPhase = ((100 - p) * 0.5 / 100).toFixed(2); 
                label.textContent = `遮罩 ${p}% (${scPhase})`; 
                unitItem.appendChild(label);

                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                // wrapper 和 canvas 的實際尺寸
                wrapper.style.width = `${finalCanvasBaseSize * scaleFactor}px`;
                wrapper.style.height = `${finalCanvasBaseSize * scaleFactor}px`;

                const divId = `lr-w${p}-${scaleFactor.toFixed(2).replace('.', '_')}`; 
                wrapper.id = divId;
                unitItem.appendChild(wrapper);
                leftContainer.appendChild(unitItem);
                // 呼叫 drawMoon 時傳遞所有新的控制參數
                drawMoon(divId, scaleFactor, p, false, targetMoonDiameterDisplay, overallMarginRatio, dotPixelSize, maskLineThickness); 
            }

            for (let p = 0; p <= 100; p += 5) {
                const unitItem = document.createElement('div');
                unitItem.className = 'moon-unit-item';

                const label = document.createElement('div');
                label.className = 'percentage-label';
                const scPhase = (0.5 + (p * 0.5 / 100)).toFixed(2); 
                label.textContent = `遮罩 ${p}% (${scPhase})`; 
                unitItem.appendChild(label);

                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                wrapper.style.width = `${finalCanvasBaseSize * scaleFactor}px`;
                wrapper.style.height = `${finalCanvasBaseSize * scaleFactor}px`;

                const divId = `rl-w${p}-${scaleFactor.toFixed(2).replace('.', '_')}`; 
                wrapper.id = divId;
                unitItem.appendChild(wrapper);
                rightContainer.appendChild(unitItem);
                // 呼叫 drawMoon 時傳遞所有新的控制參數
                drawMoon(divId, scaleFactor, p, true, targetMoonDiameterDisplay, overallMarginRatio, dotPixelSize, maskLineThickness); 
            }
        };

        moonImg.onerror = () => {
            alert('無法載入月亮底圖，請檢查圖片網址或網路連線。所有月相圖將顯示為預設背景。');
            const leftContainer = document.getElementById('left-container');
            const rightContainer = document.getElementById('right-container');
            
            const tiltDeg = 23.4;
            const tiltRad = tiltDeg * Math.PI / 180;
            const moonBBoxNoMargin = targetMoonDiameterDisplay * (Math.abs(Math.cos(tiltRad)) + Math.abs(Math.sin(tiltRad)));
            const canvasBaseSize = moonBBoxNoMargin / (1 - 2 * overallMarginRatio);
            const finalCanvasBaseSize = Math.ceil(canvasBaseSize);

            for (let p = 100; p >= 0; p -= 5) {
                const unitItem = document.createElement('div');
                unitItem.className = 'moon-unit-item';
                const label = document.createElement('div');
                label.className = 'percentage-label';
                const scPhase = ((100 - p) * 0.5 / 100).toFixed(2); 
                label.textContent = `遮罩 ${p}% (${scPhase}) (無底圖)`; 
                unitItem.appendChild(label);

                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                wrapper.style.width = `${finalCanvasBaseSize * scaleFactor}px`;
                wrapper.style.height = `${finalCanvasBaseSize * scaleFactor}px`;
                const divId = `lr-w${p}-${scaleFactor.toFixed(2).replace('.', '_')}-noimg`;
                wrapper.id = divId;
                unitItem.appendChild(wrapper);
                leftContainer.appendChild(unitItem);
                drawMoon(divId, scaleFactor, p, false, targetMoonDiameterDisplay, overallMarginRatio, dotPixelSize, maskLineThickness);
            }

            for (let p = 0; p <= 100; p += 5) {
                const unitItem = document.createElement('div');
                unitItem.className = 'moon-unit-item';
                const label = document.createElement('div');
                label.className = 'percentage-label';
                const scPhase = (0.5 + (p * 0.5 / 100)).toFixed(2); 
                label.textContent = `遮罩 ${p}% (${scPhase}) (無底圖)`; 
                unitItem.appendChild(label);

                const wrapper = document.createElement('div');
                wrapper.className = 'figure-wrapper';
                wrapper.style.width = `${finalCanvasBaseSize * scaleFactor}px`;
                wrapper.style.height = `${finalCanvasBaseSize * scaleFactor}px`;
                const divId = `rl-w${p}-${scaleFactor.toFixed(2).replace('.', '_')}-noimg`;
                wrapper.id = divId;
                unitItem.appendChild(wrapper);
                rightContainer.appendChild(unitItem);
                drawMoon(divId, scaleFactor, p, true, targetMoonDiameterDisplay, overallMarginRatio, dotPixelSize, maskLineThickness);
            }
        };
    </script>
</body>
</html>